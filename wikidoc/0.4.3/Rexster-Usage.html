<!DOCTYPE html>

<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Rexster Usage</title>
    <link rel="stylesheet" href="./css/screen.css" type="text/css" charset="utf-8" />
    <link rel="stylesheet" href="./css/gollum.css" type="text/css" charset="utf-8" />
    <link rel="stylesheet" href="./css/syntax.css" type="text/css" charset="utf-8" />
    <script src="./javascript/jquery-1.4.2.min.js" type="text/javascript"></script>
    <script src="./javascript/jquery.text_selection-1.0.0.min.js" type="text/javascript"></script>
    <script src="./javascript/jquery.previewable_comment_form.js" type="text/javascript"></script>
    <script src="./javascript/jquery.tabs.js" type="text/javascript"></script>
    <script src="./javascript/gollum.js" type="text/javascript"></script>
  </head>

  <body>
    <div id="main">
      <div class="site">
        <div id="guides">
          <div class="guide">
            <div class="main">
              <div class="actions">
                <div>
                  <a href="./Home.html">Aurelius Faunus 0.4.3</a>
                </div>
              </div>
              <h1>Rexster Usage</h1>
              <div class="content wikistyle gollum textile">
                <p><a href="http://rexster.tinkerpop.com"><img src="https://github.com/tinkerpop/rexster/raw/master/doc/images/rexster-logo.png" alt=""></a></p>
<p>In addition to processing Faunus scripts on the <a class="internal present" href="./Command-Line-Usage.html">command line</a>, it is also possible to  remotely execute and monitor scripts with <a href="http://rexster.tinkerpop.com">Rexster</a> via <span class="caps">REST</span>-based requests.  Faunus comes with a <a href="https://github.com/tinkerpop/rexster/wiki/Extensions">Rexster Extension</a>, called the Faunus Executor Extension, which enables this capability.</p>
<h2>Configuration</h2>
<p>The following configuration instructions assume that Faunus and its related dependencies are installed and configured as described in the <a class="internal present" href="./Getting-Started.html">Getting Started</a> section.  For demonstration purposes, it further assumes the use of Titan Cassandra in <a href="https://github.com/thinkaurelius/titan/wiki/Using-Cassandra#local-server-mode">Local Server Mode</a> and is loaded with the <a href="https://github.com/tinkerpop/gremlin/wiki/Defining-a-More-Complex-Property-Graph">Grateful Dead dataset</a> which comes <a href="https://github.com/tinkerpop/rexster/tree/master/rexster-server/data/graph-example-2">packaged</a> with Rexster.  Finally, it assumes that Rexster is <a href="https://github.com/tinkerpop/rexster/wiki/Downloads">downloaded</a> and unpackaged to <code>REXSTER_HOME</code>.</p>
<p>To deploy the Executor Extension (<code>FaunusRexsterExecutorExtension</code>), simply copy the following Faunus <code>jar</code> files to <code>REXSTER_HOME/ext</code> (see <a href="https://github.com/tinkerpop/rexster/wiki/Deploying-an-Extension">Deploying an Extension</a> in the Rexster Wiki for more information):</p>
<ul>
<li><code>faunus-x.y.z.jar</code></li>
	<li><code>faunus-x.y.z-job.jar</code></li>
</ul><p>With those <code>jar</code> files in place, Rexster now has the capability to find the Executor Extension.  The assumption is that the jars in the Titan <code>lib</code> directory are also exposed to Rexster in the <code>REXSTER_HOME/ext</code> directory.  If not, it may be best to copy all of the jars in the Faunus <code>lib</code> directory to Rexster.  Ensure that the <code>titan-rexster-x.y.z.jar</code> is present as well so that Rexster can configure the Titan graph instance.</p>
<p>To tell Rexster to explicitly “allow” the extension, edit Rexster’s <code>REXSTER_HOME/config/rexster.xml</code> file and include the following:</p>
<div class="highlight">
<pre><span class="nt">&lt;graph&gt;</span>
  <span class="nt">&lt;graph-name&gt;</span>titanexample<span class="nt">&lt;/graph-name&gt;</span>
  <span class="nt">&lt;graph-type&gt;</span>com.thinkaurelius.titan.tinkerpop.rexster.TitanGraphConfiguration<span class="nt">&lt;/graph-type&gt;</span>
  <span class="nt">&lt;graph-read-only&gt;</span>false<span class="nt">&lt;/graph-read-only&gt;</span>
  <span class="nt">&lt;properties&gt;</span>
    <span class="nt">&lt;storage.backend&gt;</span>cassandrathrift<span class="nt">&lt;/storage.backend&gt;</span>
    <span class="nt">&lt;storage.hostname&gt;</span>localhost<span class="nt">&lt;/storage.hostname&gt;</span>
  <span class="nt">&lt;/properties&gt;</span>
  <span class="nt">&lt;extensions&gt;</span>
    <span class="nt">&lt;allows&gt;</span>
      <span class="nt">&lt;allow&gt;</span>tp:gremlin<span class="nt">&lt;/allow&gt;</span>
      <span class="nt">&lt;allow&gt;</span>faunus:executor<span class="nt">&lt;/allow&gt;</span>
    <span class="nt">&lt;/allows&gt;</span>
    <span class="nt">&lt;extension&gt;</span>
      <span class="nt">&lt;namespace&gt;</span>faunus<span class="nt">&lt;/namespace&gt;</span>
      <span class="nt">&lt;name&gt;</span>executor<span class="nt">&lt;/name&gt;</span>
      <span class="nt">&lt;configuration&gt;</span>
        <span class="nt">&lt;faunus.graph.input.format&gt;</span>com.thinkaurelius.faunus.formats.titan.cassandra.TitanCassandraInputFormat<span class="nt">&lt;/faunus.graph.input.format&gt;</span>
        <span class="nt">&lt;faunus.graph.input.titan.storage.backend&gt;</span>cassandrathrift<span class="nt">&lt;/faunus.graph.input.titan.storage.backend&gt;</span>
        <span class="nt">&lt;faunus.graph.input.titan.storage.hostname&gt;</span>localhost<span class="nt">&lt;/faunus.graph.input.titan.storage.hostname&gt;</span>
        <span class="nt">&lt;faunus.graph.input.titan.storage.port&gt;</span>9160<span class="nt">&lt;/faunus.graph.input.titan.storage.port&gt;</span>
        <span class="nt">&lt;faunus.graph.input.titan.storage.keyspace&gt;</span>titan<span class="nt">&lt;/faunus.graph.input.titan.storage.keyspace&gt;</span>
        <span class="nt">&lt;cassandra.input.partitioner.class&gt;</span>org.apache.cassandra.dht.RandomPartitioner<span class="nt">&lt;/cassandra.input.partitioner.class&gt;</span>
        <span class="nt">&lt;faunus.graph.output.format&gt;</span>com.thinkaurelius.faunus.formats.graphson.GraphSONOutputFormat<span class="nt">&lt;/faunus.graph.output.format&gt;</span>
        <span class="nt">&lt;faunus.sideeffect.output.format&gt;</span>org.apache.hadoop.mapreduce.lib.output.TextOutputFormat<span class="nt">&lt;/faunus.sideeffect.output.format&gt;</span>
        <span class="nt">&lt;faunus.output.location&gt;</span>output<span class="nt">&lt;/faunus.output.location&gt;</span>
        <span class="nt">&lt;faunus.output.location.overwrite&gt;</span>true<span class="nt">&lt;/faunus.output.location.overwrite&gt;</span>
        <span class="nt">&lt;fs.default.name&gt;</span>hdfs://localhost:9000/<span class="nt">&lt;/fs.default.name&gt;</span>
        <span class="nt">&lt;mapred.job.tracker&gt;</span>localhost:9001<span class="nt">&lt;/mapred.job.tracker&gt;</span>
      <span class="nt">&lt;/configuration&gt;</span>
    <span class="nt">&lt;/extension&gt;</span>
  <span class="nt">&lt;/extensions&gt;</span>
<span class="nt">&lt;/graph&gt;</span>
</pre>
</div>

<p>The configuration above does two things.  First, it adds a graph called <code>titanexample</code> that connects to the running Cassandra instance from the assumptions given above (see <a href="https://github.com/thinkaurelius/titan/wiki/Rexster-Graph-Server#configuring-rexster">Configuring Rexster</a> in the Titan Wiki for more information on that aspect of the configuration).  Second, it tells Rexster to expose the Executor Extension with <code>&lt;allow&gt;faunus:executor&lt;/allow&gt;</code> and then configures it in the <code>&lt;extension&gt;</code> section below that.</p>
<p>The settings inside of the <code>&lt;configuration&gt;</code> section represents the settings that would traditionally be provided via some <code>faunus.properties</code> file. These properties are fed into Faunus in basically the same manner as provided for by:</p>
<div class="highlight">
<pre>gremlin&gt; g = FaunusFactory.open('bin/faunus.properties')
==&gt;faunusgraph[graphsoninputformat-&gt;graphsonoutputformat]
</pre>
</div>

<p>Rexster needs to know where Faunus is.  Set <code>FAUNUS_HOME</code> environment variable to point to the Faunus installation directory.  Consider just editing <code>bin/rexster.sh</code> and adding this line to the start of the file:</p>
<div class="highlight">
<pre>export FAUNUS_HOME=/path/to/faunus
</pre>
</div>

<p>Start Rexster with:</p>
<div class="highlight">
<pre>bin/rexster.sh -s
</pre>
</div>

<p>and note the log output to the console where the following lines should be displayed:</p>
<div class="highlight">
<pre>[INFO] RexsterApplicationGraph - Graph [titanexample] - configured with allowable namespace [tp:gremlin]
[INFO] RexsterApplicationGraph - Graph [titanexample] - configured with allowable namespace [faunus:executor]
[INFO] GraphConfigurationContainer - Graph titanexample - titangraph[cassandrathrift:localhost] loaded
</pre>
</div>

<h2>
<span class="caps">REST</span> <span class="caps">API</span>
</h2>
<p>The Faunus Executor Extension provides support for submitting scripts to be executed and for monitoring those scripts for execution completion.</p>
<h3>Starting a Faunus Job with <span class="caps">POST</span>
</h3>
<p>The Faunus Executor Extension accepts an <span class="caps">HTTP</span> <code>POST</code> of a script and overriding configuration options to create a Faunus <code>job</code> instance.  The <code>job</code> is started at the time the request is received and executes asynchronously on the server.  The following example utilizes <a href="http://curl.haxx.se/">cURL</a> to issue a request to execute a Faunus script in Rexster:</p>
<div class="highlight">
<pre>curl -H "Content-Type:application/json" -X POST -d "{'config':{'faunus.output.location':'output-1'}, 'script':'g.V.out.name.groupCount'}" "http://localhost:8182/graphs/titanexample/faunus/executor"
</pre>
</div>

<p>which almost immediately returns:</p>
<div class="highlight">
<pre><span class="p">{</span><span class="s2">"job"</span><span class="o">:</span><span class="s2">"80e2a556-b9d3-4306-bf7b-00dd2bfc6f19"</span><span class="p">,</span><span class="s2">"version"</span><span class="o">:</span><span class="s2">"x.y.z-SNAPSHOT"</span><span class="p">,</span><span class="s2">"queryTime"</span><span class="o">:</span><span class="mf">8.748225</span><span class="p">}</span>
</pre>
</div>

<p>At this point the <code>job</code> is executing on the server.  The returned <code>job</code> identifier provides a handle, by which the job can be monitored to determine when the server is done processing the <code>job</code>.</p>
<p>Given the above cURL example, Faunus is now processing this script:</p>
<div class="highlight">
<pre>g.V.out.name.groupCount
</pre>
</div>

<p>and is placing the output in <code>output-1</code>.  It is important to note that <code>output-1</code> as set in the <code>config</code> key of the POSTed JSOn, is an <em>override</em> of the value provided in <code>rexster.xml</code>, where the value is just <code>output</code>.  In fact, any key-value pair in the <code>config</code> key will become a property passed to Faunus.  These values will override any provided in <code>rexster.xml</code>.</p>
<h3>Monitoring the Job with <span class="caps">GET</span>
</h3>
<p>To get the status of a <code>job</code>, make another request to the Faunus Executor Service providing the <code>job</code> identifier returned with the <code>POST</code> as a query string argument.  While the job is still running, a request made as follows:</p>
<div class="highlight">
<pre>curl "http://localhost:8182/graphs/titanexample/faunus/executor?job=80e2a556-b9d3-4306-bf7b-00dd2bfc6f19"
</pre>
</div>

<p>will return:</p>
<div class="highlight">
<pre><span class="p">{</span>
    <span class="s2">"message"</span><span class="o">:</span> <span class="s2">""</span><span class="p">,</span>
    <span class="s2">"status"</span><span class="o">:</span> <span class="s2">"processing"</span><span class="p">,</span>
    <span class="s2">"job"</span><span class="o">:</span> <span class="s2">"80e2a556-b9d3-4306-bf7b-00dd2bfc6f19"</span><span class="p">,</span>
    <span class="s2">"version"</span><span class="o">:</span> <span class="s2">"x.y.z-SNAPSHOT"</span><span class="p">,</span>
    <span class="s2">"queryTime"</span><span class="o">:</span> <span class="mf">0.883452</span>
<span class="p">}</span>
</pre>
</div>

<p>When the <code>job</code> completes it will return:</p>
<div class="highlight">
<pre><span class="p">{</span>
    <span class="s2">"message"</span><span class="o">:</span> <span class="s2">""</span><span class="p">,</span>
    <span class="s2">"status"</span><span class="o">:</span> <span class="s2">"complete"</span><span class="p">,</span>
    <span class="s2">"job"</span><span class="o">:</span> <span class="s2">"80e2a556-b9d3-4306-bf7b-00dd2bfc6f19"</span><span class="p">,</span>
    <span class="s2">"version"</span><span class="o">:</span> <span class="s2">"x.y.z-SNAPSHOT"</span><span class="p">,</span>
    <span class="s2">"queryTime"</span><span class="o">:</span> <span class="mf">0.883452</span>
<span class="p">}</span>
</pre>
</div>

<p>In the event of an error processing the <code>job</code> the response will contain a <code>status</code> of <code>error</code> and the <code>message</code> field will contain some details.  In this case, it will be important to check the Rexster logs for more details on the problem.</p>
<p>Once a <code>job</code> is complete (by way of error or success), the reference to the <code>job</code> is removed from Rexster and future requests for that <code>job</code> identifier will return a <code>404</code> status code (Not Found).</p>
<p>When the <code>job</code> is complete, the results will be pushed into <span class="caps">HDFS</span> (assuming the configuration described thus far).  One way to view the side-effect generated group count would be to use the <span class="caps">REPL</span>:</p>
<div class="highlight">
<pre>gremlin&gt; hdfs.ls('output-1')                    
==&gt;rwxr-xr-x smallette supergroup 0 (D) job-0
==&gt;rwxr-xr-x smallette supergroup 0 (D) job-1
gremlin&gt; hdfs.head('output-1/job-1/sideeffect*')
==&gt;A MIND TO GIVE UP LIVIN	1
==&gt;A.P.Carter	1
==&gt;ADDAMS FAMILY	2
==&gt;AINT SUPERSTITIOUS	3
==&gt;ALABAMA GETAWAY	38
...
==&gt;YOU AINT WOMAN ENOUGH	13
==&gt;YOU WIN AGAIN	8
==&gt;YOU WONT FIND ME	1
==&gt;YOUR LOVE AT HOME	1
==&gt;instrumental	8
</pre>
</div>

              </div>
            </div>
          </div>
          <div class="admin">
            <div style="float: left;">
              <small>Last edited by <b>Dan LaRocque</b>, 2014-04-21 19:19:18</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
