<!DOCTYPE html>

<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Titan Format</title>
    <link rel="stylesheet" href="./css/screen.css" type="text/css" charset="utf-8" />
    <link rel="stylesheet" href="./css/gollum.css" type="text/css" charset="utf-8" />
    <link rel="stylesheet" href="./css/syntax.css" type="text/css" charset="utf-8" />
    <script src="./javascript/jquery-1.4.2.min.js" type="text/javascript"></script>
    <script src="./javascript/jquery.text_selection-1.0.0.min.js" type="text/javascript"></script>
    <script src="./javascript/jquery.previewable_comment_form.js" type="text/javascript"></script>
    <script src="./javascript/jquery.tabs.js" type="text/javascript"></script>
    <script src="./javascript/gollum.js" type="text/javascript"></script>
  </head>

  <body>
    <div id="main">
      <div class="site">
        <div id="guides">
          <div class="guide">
            <div class="main">
              <div class="actions">
                <div>
                  <a href="./Home.html">Aurelius Faunus 0.4.3</a>
                </div>
              </div>
              <h1>Titan Format</h1>
              <div class="content wikistyle gollum textile">
                <p><img src="http://thinkaurelius.github.com/titan/images/titan-logo.png" width="400px"></p>
<ul>
<li>
<strong>InputFormat</strong>: <code>com.thinkaurelius.faunus.formats.titan.cassandra.TitanCassandraInputFormat</code>
</li>
	<li>
<strong>InputFormat</strong>: <code>com.thinkaurelius.faunus.formats.titan.hbase.TitanHBaseInputFormat</code>
</li>
</ul><ul>
<li>
<strong>OutputFormat</strong>: <code>com.thinkaurelius.faunus.formats.titan.cassandra.TitanCassandraOutputFormat</code>
</li>
	<li>
<strong>OutputFormat</strong>: <code>com.thinkaurelius.faunus.formats.titan.hbase.TitanHBaseOutputFormat</code>
</li>
</ul><p><a href="http://thinkaurelius.github.com/titan/">Titan</a> is a distributed graph database developed by <a href="http://thinkaurelius.com/">Aurelius</a> and provided under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache 2</a> license. Titan is backend agnostic and is currently deployed with support for Apache <a href="http://cassandra.apache.org/">Cassandra</a> and Apache <a href="http://hbase.apache.org/">HBase</a> (see <a href="https://github.com/thinkaurelius/titan/wiki/The-Benefits-of-Titan">The Benefits of Titan</a> and <a href="https://github.com/thinkaurelius/titan/wiki/Storage-Backend-Overview">Storage Backend Overview</a>). Faunus can be used to bulk load, incremental load, and read data to and from a Titan cluster.</p>
<h2>Titan InputFormat Support</h2>
<p>An <code>InputFormat</code> specifies how to turn a data source into a stream of Hadoop <code>&lt;KEY,VALUE&gt;</code> pairs (see <a href="http://www.infoq.com/articles/HadoopInputFormat">blog post</a>). For Faunus, this means turning the source data into a stream of <code>&lt;NullWritable, FaunusVertex&gt;</code> pairs. The following <code>TitanXXXInputFormat</code> classes stream Titan encoded data contained within <a href="http://cassandra.apache.org/">Cassandra</a> and <a href="http://hbase.apache.org/">HBase</a> into Faunus/Hadoop.</p>
<h3>TitanCassandraInputFormat</h3>
<p><img src="http://cassandra.apache.org/media/img/cassandra_logo.png" width="250px"></p>
<p>In order to read graph data from Titan/Cassandra, a graph needs to exist. For the sake of an example, <em>The Graph of the Gods</em> dataset deployed with Titan can be loaded using <a href="http://gremlin.tinkerpop.com">Gremlin</a> (see diagram at <a class="internal present" href="./Getting-Started.html">Getting Started</a>).</p>
<div class="highlight">
<pre>gremlin&gt; g = TitanFactory.open('bin/cassandra.local')
==&gt;titangraph[cassandra:127.0.0.1]
gremlin&gt; g.loadGraphML('data/graph-of-the-gods.xml')
==&gt;null
gremlin&gt; g.commit()
</pre>
</div>

<p>In Faunus, a <code>bin/titan-cassandra-input.properties</code> file is provided with the following properties which tell Faunus the location and features of the Titan/Cassandra cluster.</p>
<div class="highlight">
<pre><span class="na">faunus.graph.input.format</span><span class="o">=</span><span class="s">com.thinkaurelius.faunus.formats.titan.cassandra.TitanCassandraInputFormat</span>
<span class="na">faunus.graph.input.titan.storage.backend</span><span class="o">=</span><span class="s">cassandra</span>
<span class="na">faunus.graph.input.titan.storage.hostname</span><span class="o">=</span><span class="s">localhost</span>
<span class="na">faunus.graph.input.titan.storage.port</span><span class="o">=</span><span class="s">9160</span>
<span class="na">faunus.graph.input.titan.storage.keyspace</span><span class="o">=</span><span class="s">titan</span>
<span class="na">cassandra.input.partitioner.class</span><span class="o">=</span><span class="s">org.apache.cassandra.dht.RandomPartitioner</span>
<span class="c"># cassandra.input.split.size=512</span>
</pre>
</div>

<div class="highlight">
<pre>gremlin&gt; g = FaunusFactory.open('bin/titan-cassandra-input.properties')      
==&gt;faunusgraph[titancassandrainputformat]
gremlin&gt; g.V.count()
13/01/04 12:53:24 INFO mapreduce.FaunusCompiler: Compiled to 1 MapReduce job(s)
13/01/04 12:53:24 INFO mapreduce.FaunusCompiler: Executing job 1 out of 1: MapSequence[com.thinkaurelius.faunus.mapreduce.transform.VerticesMap.Map, com.thinkaurelius.faunus.mapreduce.util.CountMapReduce.Map, com.thinkaurelius.faunus.mapreduce.util.CountMapReduce.Reduce]
...
==&gt;12
</pre>
</div>

<p><strong><span class="caps">NOTE</span></strong>: When using Titan/Cassandra as a data source, and if there are vertices with a large number of edges (i.e. a very wide row in Cassandra), an inoculous exception may occur warning that the thrift frame size has been exceeded. While the <code>cassandra.yaml</code> can be updated and the following job properties added <code>cassandra.thrift.framed.size_mb</code>/<code>cassandra.thrift.message.max_size_mb</code>, typically, the easiest way to solve this is to add the following property to the <code>FaunusGraph</code> being worked with: <code>cassandra.input.split.size=512</code> (see <code>bin/titan-cassandra-input.properties</code>). The value <code>512</code> is how many kilobytes to make the input split size and this value can be adjusted higher or lower to ensure performant, non-excepting behavior.</p>
<h3>TitanHBaseInputFormat</h3>
<p><img src="http://hbase.apache.org/images/hbase_logo.png" width="200px"></p>
<p><em>The Graph of the Gods</em> dataset deployed with Titan can be loaded into Titan/HBase using <a href="http://gremlin.tinkerpop.com">Gremlin</a> (see diagram at <a class="internal present" href="./Getting-Started.html">Getting Started</a>).</p>
<div class="highlight">
<pre>gremlin&gt; g = TitanFactory.open('bin/hbase.local')
==&gt;titangraph[hbase:127.0.0.1]
gremlin&gt; g.loadGraphML('data/graph-of-the-gods.xml')
==&gt;null
gremlin&gt; g.commit()
</pre>
</div>

<p>In Faunus, a <code>bin/titan-hbase-input.properties</code> file is provided with the following properties. This creates a <code>FaunusGraph</code> that is fed from Titan/HBase. Note, for multi-machines environments, the <code>titan.graph.input.storage.hostname</code> should use the cluster-internal IP address of the machine with <a href="http://zookeeper.apache.org/">Zookeeper</a> even if that machine is in fact <code>localhost</code>.</p>
<div class="highlight">
<pre><span class="na">faunus.graph.input.format</span><span class="o">=</span><span class="s">com.thinkaurelius.faunus.formats.titan.hbase.TitanHBaseInputFormat</span>
<span class="na">faunus.graph.input.titan.storage.backend</span><span class="o">=</span><span class="s">hbase</span>
<span class="na">faunus.graph.input.titan.storage.hostname</span><span class="o">=</span><span class="s">localhost</span>
<span class="na">faunus.graph.input.titan.storage.port</span><span class="o">=</span><span class="s">2181</span>
<span class="na">faunus.graph.input.titan.storage.tablename</span><span class="o">=</span><span class="s">titan</span>
<span class="c"># hbase.mapreduce.scan.cachedrows=1000</span>
</pre>
</div>

<div class="highlight">
<pre>gremlin&gt; g = FaunusFactory.open('bin/titan-hbase-input.properties') 
==&gt;faunusgraph[titanhbaseinputformat]
gremlin&gt; g.V.count()
13/01/04 15:40:56 INFO mapreduce.FaunusCompiler: Compiled to 1 MapReduce job(s)
13/01/04 15:40:56 INFO mapreduce.FaunusCompiler: Executing job 1 out of 1: MapSequence[com.thinkaurelius.faunus.mapreduce.transform.VerticesMap.Map, com.thinkaurelius.faunus.mapreduce.util.CountMapReduce.Map, com.thinkaurelius.faunus.mapreduce.util.CountMapReduce.Reduce]
...
==&gt;12
</pre>
</div>

<p>Please follow the links below for more information on streaming data out of HBase.</p>
<ul>
<li><a href="http://gbif.blogspot.com/2012/02/performance-evaluation-of-hbase.html">http://gbif.blogspot.com/2012/02/performance-evaluation-of-hbase.html</a></li>
</ul><h2>Titan OutputFormat Support</h2>
<p>Faunus can be used to bulk load data into Titan. Thus, given a stream of <code>&lt;NullWritable, FaunusVertex&gt;</code> pairs, with a <code>TitanXXXOutputFormat</code> the stream is faithfully written to Titan. For all the examples to follow, it is assumed that <code>data/graph-of-the-gods.json</code> is in <span class="caps">HDFS</span>. Finally, note that is is typically a good idea to have the graph (keyspace/table) already initialized (e.g. <code>g = TitanFactory.open(...)</code>) before doing bulk writing as the creation process takes time and a heavy write load during the graph creation process can yield exceptions.</p>
<p>When writing a Faunus graph to Titan, there are two MapReduce phases. The first Map-phase writes all the vertices of the graph and computes the Titan generated ID and maintains a map between the Faunus vertex ID and the Titan vertex ID. The reduce phase distributes that Faunus-Titan ID map to all edge pairs and thus, a read-only distributed hash map is created. In the second MapReduce phase, the Map writes all the edges and there is no reducer.</p>
<p>During the map phases described above, numerous transactions are being committed. The size of the transaction is the size of the full task. The mechanism to control the size of a task for both the mappers and reducers is using <code>mapred.max.split.size</code>. Be sure that the size of the split is not so large that OEMs occur and so small that very little data is being written. Furthermore, some backends prefer larger TX sizes (Cassandra:<code>20-30MB</code>) and others prefer smaller TX sizes (HBase:<code>5-10MB</code>). It is best to play with these TX sizes/split-sizes  as performance can be greatly effected and is highly dependent on the backend storage system, the topology of the graph, and the backend configuration (e.g. replication factor, durable writes, etc.). Finally, it is best to have <code>mapred.job.reuse.jvm.num.tasks=-1</code> (or a large number like <code>1000</code>) as transactions are typically small and <span class="caps">JVM</span> start up time may be costly in the long run.</p>
<p><strong><span class="caps">NOTE</span></strong>: For those importing into Titan using an external index such as <a href="http://www.elasticsearch.org">Elasticsearch</a>, be sure to provide the appropriate properties referencing the Elasticsearch cluster. The example properties below are provided commented out in the example <code>TitanOutputFormat</code> properties files distributed with Faunus.</p>
<div class="highlight">
<pre><span class="na">faunus.graph.output.titan.storage.index.search.backend</span><span class="o">=</span><span class="s">elasticsearch</span>
<span class="na">faunus.graph.output.titan.storage.index.search.hostname</span><span class="o">=</span><span class="s">127.0.0.1</span>
<span class="na">faunus.graph.output.titan.storage.index.search.client-only</span><span class="o">=</span><span class="s">true</span>
</pre>
</div>

<h3>TitanCassandraOutputFormat</h3>
<p><img src="http://cassandra.apache.org/media/img/cassandra_logo.png" width="250px"></p>
<div class="highlight">
<pre><span class="na">faunus.graph.output.format</span><span class="o">=</span><span class="s">com.thinkaurelius.faunus.formats.titan.cassandra.TitanCassandraOutputFormat</span>
<span class="na">faunus.graph.output.titan.storage.backend</span><span class="o">=</span><span class="s">cassandra</span>
<span class="na">faunus.graph.output.titan.storage.hostname</span><span class="o">=</span><span class="s">localhost</span>
<span class="na">faunus.graph.output.titan.storage.port</span><span class="o">=</span><span class="s">9160</span>
<span class="na">faunus.graph.output.titan.storage.keyspace</span><span class="o">=</span><span class="s">titan</span>
<span class="na">faunus.graph.output.titan.storage.batch-loading</span><span class="o">=</span><span class="s">true</span>
<span class="c"># faunus.graph.output.titan.ids.block-size=100000</span>
<span class="na">faunus.graph.output.titan.infer-schema</span><span class="o">=</span><span class="s">true</span>
</pre>
</div>

<p>Here are some notes for the above properties.</p>
<ul>
<li>
<code>storage.batch-loading</code>: By setting this to true, certain checks in Titan are circumvented which speeds up the writing process.</li>
	<li>
<code>ids.block-size</code>: When this value is small and the clients are writing lots of data, the clients communicates with Titan repeatedly to get new ids and this can cause exceptions to happen as the id system stalls trying to serve all the clients.</li>
	<li>
<code>infer-schema</code>: When a new edge label or property key is provided to Titan, Titan updates its schema metadata. By inferring the schema prior to writing, exceptions can be circumvented.</li>
</ul><div class="highlight">
<pre>gremlin&gt; g = FaunusFactory.open('bin/titan-cassandra-output.properties') 
==&gt;faunusgraph[graphsoninputformat]
gremlin&gt; g.V.sideEffect('{it.roman = true}') 
13/01/04 15:44:42 INFO mapreduce.FaunusCompiler: Compiled to 1 MapReduce job(s)
13/01/04 15:44:42 INFO mapreduce.FaunusCompiler: Executing job 1 out of 1: MapSequence[com.thinkaurelius.faunus.mapreduce.transform.VerticesMap.Map, com.thinkaurelius.faunus.mapreduce.sideeffect.SideEffectMap.Map, com.thinkaurelius.faunus.formats.BlueprintsGraphOutputMapReduce.Map, com.thinkaurelius.faunus.formats.BlueprintsGraphOutputMapReduce.Reduce]
...
</pre>
</div>

<p>In the above job, the <em>Graph of the Gods</em> GraphSON file is streamed from <span class="caps">HDFS</span> and each vertex has a new property added (<code>roman=true</code>). The output graph is pushed into Titan/Cassandra. Via the Titan/Gremlin console, the graph is viewable.</p>
<div class="highlight">
<pre>titan$ bin/gremlin.sh 

         \,,,/
         (o o)
-----oOOo-(_)-oOOo-----
gremlin&gt; g = TitanFactory.open('bin/cassandra.local')
==&gt;titangraph[cassandrathrift:127.0.0.1]
gremlin&gt; g.v(4).map
==&gt;{name=saturn, type=titan, roman=true}
gremlin&gt;
</pre>
</div>

<h3>TitanHBaseOutputFormat</h3>
<p><img src="http://hbase.apache.org/images/hbase_logo.png" width="200px"></p>
<div class="highlight">
<pre><span class="na">faunus.graph.output.format</span><span class="o">=</span><span class="s">com.thinkaurelius.faunus.formats.titan.hbase.TitanHBaseOutputFormat</span>
<span class="na">faunus.graph.output.titan.storage.backend</span><span class="o">=</span><span class="s">hbase</span>
<span class="na">faunus.graph.output.titan.storage.hostname</span><span class="o">=</span><span class="s">localhost</span>
<span class="na">faunus.graph.output.titan.storage.port</span><span class="o">=</span><span class="s">2181</span>
<span class="na">faunus.graph.output.titan.storage.tablename</span><span class="o">=</span><span class="s">titan</span>
<span class="na">faunus.graph.output.titan.storage.batch-loading</span><span class="o">=</span><span class="s">true</span>
<span class="c"># titan.graph.output.ids.block-size=100000</span>
<span class="na">faunus.graph.output.titan.infer-schema</span><span class="o">=</span><span class="s">true</span>
</pre>
</div>

<p><strong><span class="caps">NOTE</span>:</strong> Please see the <code>TitanCassandraOutputFormat</code> section for information the meaning of these properties.</p>
<p>In Titan/HBase there are two other parameters that should be considered.<br></p><div class="highlight">
<pre><span class="na">faunus.graph.output.titan.ids.num-partitions</span><span class="o">=</span><span class="s">5 // typically the number of region servers</span>
<span class="na">faunus.graph.output.titan.ids.partition</span><span class="o">=</span><span class="s">true</span>
</pre>
</div>
<br>
Because Titan/HBase does not randomly distribute the data around the cluster it is good to tell Titan to generate random partitions of the ID space so that data is written in (as best as possible) a round robin fashion so no single region server is burdened with data writes.
<div class="highlight">
<pre>gremlin&gt; g = FaunusFactory.open('bin/titan-hbase-output.properties')    
==&gt;faunusgraph[graphsoninputformat]
gremlin&gt; g.V.sideEffect('{it.roman = true}')                           
13/01/04 15:48:32 INFO mapreduce.FaunusCompiler: Compiled to 1 MapReduce job(s)
13/01/04 15:48:32 INFO mapreduce.FaunusCompiler: Executing job 1 out of 1: MapSequence[com.thinkaurelius.faunus.mapreduce.transform.VerticesMap.Map, com.thinkaurelius.faunus.mapreduce.sideeffect.SideEffectMap.Map, com.thinkaurelius.faunus.formats.BlueprintsGraphOutputMapReduce.Map, com.thinkaurelius.faunus.formats.BlueprintsGraphOutputMapReduce.Reduce]
...
</pre>
</div>

<h2>Incremental Data Loading using a TitanOutputFormat</h2>
<p>Faunus can be used for incremental loading. That is, loading data into a graph that already exists. The Faunus property to be aware of is <code>faunus.graph.output.blueprints.script-file</code>. If that property does not exist, then it is assumed that the underlying graph is empty. If the property does exist, it points to a file in <span class="caps">HDFS</span> that is a Gremlin/Groovy script that has either or both of the following two methods:</p>
<ul>
<li><code>def Vertex getOrCreateVertex(FaunusVertex vertex, Graph graph, Mapper.Context context)</code></li>
	<li><code>def Edge getOrCreateEdge(FaunusEdge faunusEdge, Vertex blueprintsOutVertex, Vertex blueprintsInVertex, Graph graph, Mapper.Context context)</code></li>
</ul><p>An example <code>getOrCreateVertex()</code> definition is in the code fragment below. The example determines whether a vertex already exists in the graph by a unique key (e.g. a domain-specific unique address space). If the vertex exists according to a global index query, then return it. Else, create a new vertex and return it. This example is distributed with Faunus in <code>data/BlueprintsScript.groovy</code> (e.g. <code>hadoop fs -copyFromLocal data/BlueprintsScript.groovy BlueprintsScript.groovy</code>). Finally, realize that the definition of a “unique vertex” can be an arbitrary algorithm — unique key/value property, a graph traversal, accessing another dataset, etc.</p>
<div class="highlight">
<pre><span class="kt">def</span> <span class="n">Vertex</span> <span class="nf">getOrCreateVertex</span><span class="o">(</span><span class="kd">final</span> <span class="n">FaunusVertex</span> <span class="n">faunusVertex</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Graph</span> <span class="n">graph</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Mapper</span><span class="o">.</span><span class="na">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">String</span> <span class="n">uniqueKey</span> <span class="o">=</span> <span class="s2">"name"</span><span class="o">;</span>
  <span class="n">Object</span> <span class="n">uniqueValue</span> <span class="o">=</span> <span class="n">faunusVertex</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">uniqueKey</span><span class="o">);</span>
  <span class="n">Vertex</span> <span class="n">blueprintsVertex</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">uniqueValue</span><span class="o">)</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s2">"The provided Faunus vertex does not have a property for the unique key: "</span> <span class="o">+</span> <span class="n">faunusVertex</span><span class="o">);</span>

  <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Vertex</span><span class="o">&gt;</span> <span class="n">itty</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">query</span><span class="o">().</span><span class="na">has</span><span class="o">(</span><span class="n">uniqueKey</span><span class="o">,</span> <span class="n">uniqueValue</span><span class="o">).</span><span class="na">vertices</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">itty</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">blueprintsVertex</span> <span class="o">=</span> <span class="n">itty</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
    <span class="n">context</span><span class="o">.</span><span class="na">getCounter</span><span class="o">(</span><span class="n">VERTICES_RETRIEVED</span><span class="o">).</span><span class="na">increment</span><span class="o">(</span><span class="mi">1</span><span class="n">l</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">itty</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span>
      <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s2">"The unique key is not unique as more than one vertex with the value: "</span> <span class="o">+</span> <span class="n">uniqueValue</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">blueprintsVertex</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">addVertex</span><span class="o">(</span><span class="n">faunusVertex</span><span class="o">.</span><span class="na">getIdAsLong</span><span class="o">());</span>
    <span class="n">context</span><span class="o">.</span><span class="na">getCounter</span><span class="o">(</span><span class="n">VERTICES_WRITTEN</span><span class="o">).</span><span class="na">increment</span><span class="o">(</span><span class="mi">1</span><span class="n">l</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">// if vertex existed or not, add all the properties of the faunusVertex to the blueprintsVertex</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">property</span> <span class="o">:</span> <span class="n">faunusVertex</span><span class="o">.</span><span class="na">getPropertyKeys</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">blueprintsVertex</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="n">property</span><span class="o">,</span> <span class="n">faunusVertex</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">property</span><span class="o">));</span>
    <span class="n">context</span><span class="o">.</span><span class="na">getCounter</span><span class="o">(</span><span class="n">VERTEX_PROPERTIES_WRITTEN</span><span class="o">).</span><span class="na">increment</span><span class="o">(</span><span class="mi">1</span><span class="n">l</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">blueprintsVertex</span><span class="o">;</span>
<span class="o">}</span>
</pre>
</div>

<p>An example of a <code>getOrCreateEdge()</code> is provided below that says if an edge already exists between the two vertices with the same edge label return that edge, else create it.</p>
<div class="highlight">
<pre><span class="kt">def</span> <span class="n">Edge</span> <span class="nf">getOrCreateEdge</span><span class="o">(</span><span class="kd">final</span> <span class="n">FaunusEdge</span> <span class="n">faunusEdge</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Vertex</span> <span class="n">blueprintsOutVertex</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Vertex</span> <span class="n">blueprintsInVertex</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Graph</span> <span class="n">graph</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Mapper</span><span class="o">.</span><span class="na">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">Edge</span> <span class="n">blueprintsEdge</span> <span class="o">=</span> <span class="o">!</span><span class="n">blueprintsOutVertex</span><span class="o">.</span><span class="na">out</span><span class="o">(</span><span class="n">faunusEdge</span><span class="o">.</span><span class="na">getLabel</span><span class="o">()).</span><span class="na">has</span><span class="o">(</span><span class="s2">"id"</span><span class="o">,</span> <span class="n">blueprintsInVertex</span><span class="o">.</span><span class="na">getId</span><span class="o">()).</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">?</span>
        <span class="n">graph</span><span class="o">.</span><span class="na">addEdge</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">blueprintsOutVertex</span><span class="o">,</span> <span class="n">blueprintsInVertex</span><span class="o">,</span> <span class="n">faunusEdge</span><span class="o">.</span><span class="na">getLabel</span><span class="o">())</span> <span class="o">:</span>
        <span class="n">blueprintsOutVertex</span><span class="o">.</span><span class="na">outE</span><span class="o">(</span><span class="n">faunusEdge</span><span class="o">.</span><span class="na">getLabel</span><span class="o">()).</span><span class="na">as</span><span class="o">(</span><span class="s2">"here"</span><span class="o">).</span><span class="na">inV</span><span class="o">().</span><span class="na">has</span><span class="o">(</span><span class="s2">"id"</span><span class="o">,</span> <span class="n">blueprintsInVertex</span><span class="o">.</span><span class="na">getId</span><span class="o">()).</span><span class="na">back</span><span class="o">(</span><span class="s2">"here"</span><span class="o">).</span><span class="na">next</span><span class="o">();</span>
    <span class="n">context</span><span class="o">.</span><span class="na">getCounter</span><span class="o">(</span><span class="n">EDGES_WRITTEN</span><span class="o">).</span><span class="na">increment</span><span class="o">(</span><span class="mi">1</span><span class="n">l</span><span class="o">);</span>

    <span class="c1">// if edge existed or not, add all the properties of the faunusEdge to the blueprintsEdge</span>
    <span class="k">for</span> <span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">key</span> <span class="o">:</span> <span class="n">faunusEdge</span><span class="o">.</span><span class="na">getPropertyKeys</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">blueprintsEdge</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">faunusEdge</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>
        <span class="n">context</span><span class="o">.</span><span class="na">getCounter</span><span class="o">(</span><span class="n">EDGE_PROPERTIES_WRITTEN</span><span class="o">).</span><span class="na">increment</span><span class="o">(</span><span class="mi">1</span><span class="n">l</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">blueprintsEdge</span><span class="o">;</span>
<span class="o">}</span>
</pre>
</div>

              </div>
            </div>
          </div>
          <div class="admin">
            <div style="float: left;">
              <small>Last edited by <b>Dan LaRocque</b>, 2014-04-21 19:19:18</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
